import numpy as np
import pywt
import cv2
from matplotlib import pyplot as plt
from scipy.signal import convolve2d

# Global parameters
BLOCK_SIZE = 4          # Block size for DWT (Discrete Wavelet Transform)
ALPHA = 5.70            # Scaling factor for watermark embedding
THRESHOLD_TAU = 0.57    # Similarity threshold to determine if an attack was successful
WPSNR_THRESHOLD = 35    # Threshold for wPSNR (Weighted Peak Signal-to-Noise Ratio)

# Predefined spirals used for embedding and extracting the watermark
spiral1 = [(128, 128), (95, 98), (133, 191), (175, 66), (39, 143), (213, 182), (100, 21), (73, 234), (248, 85), (3, 77), (188, 257), (287, 163), (106, 301), (266, 12), (264, 263), (333, 101), (175, 339), (337, 224), (47, 353), (343, 15), (264, 339), (390, 149), (129, 399), (353, 298), (410, 51), (232, 409), (424, 219), (62, 437), (339, 376), (463, 111), (175, 466), (432, 300)]
spiral2 = [(384, 128), (351, 98), (389, 191), (431, 66), (295, 143), (469, 182), (356, 21), (329, 234), (504, 85), (259, 77), (444, 257), (249, 206), (362, 301), (198, 121), (255, 283), (210, 7), (431, 339), (169, 196), (303, 353), (145, 65), (179, 287), (385, 399), (107, 153), (230, 373), (488, 409), (107, 259), (318, 437), (64, 89), (151, 364), (431, 466), (46, 205), (237, 452)]
spiral3 = [(128, 384), (95, 354), (133, 447), (175, 322), (39, 399), (213, 438), (100, 277), (73, 490), (248, 341), (3, 333), (172, 241), (287, 419), (31, 246), (266, 268), (119, 187), (333, 357), (238, 192), (337, 480), (38, 168), (343, 271), (171, 132), (390, 405), (312, 181), (77, 103), (410, 307), (242, 103), (424, 475), (388, 199), (140, 55), (463, 367), (323, 101), (19, 48)]
spiral4 = [(384, 384), (351, 354), (389, 447), (431, 322), (295, 399), (469, 438), (356, 277), (329, 490), (504, 341), (259, 333), (428, 241), (249, 462), (287, 246), (198, 377), (375, 187), (210, 263), (494, 192), (169, 452), (294, 168), (145, 321), (427, 132), (203, 188), (107, 409), (333, 103), (120, 249), (498, 103), (226, 114), (64, 345), (396, 55), (123, 169), (46, 461), (275, 48)]
spiral5 = [(256, 256), (223, 226), (261, 319), (303, 194), (167, 271), (341, 310), (228, 149), (201, 362), (376, 213), (131, 205), (316, 385), (300, 113), (121, 334), (415, 291), (159, 118), (234, 429), (394, 140), (70, 249), (392, 391), (247, 59), (127, 411), (461, 229), (82, 135), (303, 467), (366, 64), (41, 324), (465, 352), (166, 40), (175, 481), (471, 143), (17, 193), (392, 467)]

# List of spirals to be checked later for detection
spirals = [spiral1, spiral2, spiral3, spiral4, spiral5]

def extract_watermark(original_image, watermarked_image, coordinates):
    """
    Extracts the watermark from an image using DWT, SVD, and given spiral coordinates.
    
    Args:
    original_image: The original image before watermarking.
    watermarked_image: The watermarked image.
    coordinates: The coordinates of the spiral used for embedding.

    Returns:
    extracted_watermark: The extracted watermark as an array of singular values.
    """

    block_size = BLOCK_SIZE
    alpha = ALPHA

    S_wm_reconstructed = []

    original_image = original_image.astype(float)
    watermarked_image = watermarked_image.astype(float)

    for i, (x,y) in enumerate(coordinates):
        original_block = original_image[x:x+block_size,y:y+block_size]
        watermarked_block = watermarked_image[x:x+block_size,y:y+block_size]

        # apply wavelet to the block
        Coefficients_original = pywt.wavedec2(original_block, wavelet='haar', level=1)
        LL_block_original = Coefficients_original[0]
        Coefficients_watermarked = pywt.wavedec2(watermarked_block, wavelet='haar', level=1)
        LL_block_watermarked = Coefficients_watermarked[0]

        # perform svd on the original and watermarked LL band of the block
        U_bl_original, s_bl_original, VT_bl_original = np.linalg.svd(LL_block_original)
        U_bl_watermarked, s_bl_watermarked, VT_bl_watermarked = np.linalg.svd(LL_block_watermarked)

        # extract the watermark in the block
        S_wm_reconstructed.append((s_bl_watermarked[0] - s_bl_original[0])/alpha)

    # divisions = original_image.shape[0] / block_size
    # shape_LL_tmp = np.floor(original_image.shape[0] / (2*divisions))
    # shape_LL_tmp = np.uint8(shape_LL_tmp)

    Uwm = np.asarray([-1.59712817e-01, 1.04141130e-01,-7.82936230e-02, 1.97255293e-01,
                        -1.62074565e-02,-1.05161747e-01,-2.22527766e-01,-2.69696896e-01,
                        -8.92569538e-03, 1.77966449e-01,-2.64266272e-01, 2.75619419e-02,
                        4.54729820e-01, 3.54441112e-02, 7.95213810e-02, 2.91706573e-02,
                        9.92694873e-02, 1.83098854e-01, 1.73084999e-01,-1.33678278e-01,
                        -1.08168462e-01, 2.07630224e-01,-5.78064718e-02, 1.15848571e-01,
                        2.65779452e-01,-1.99532817e-01,-2.86467767e-01, 1.40171008e-02,
                        1.36405087e-01, 7.02157021e-03, 2.74835278e-01, 1.33373740e-01,
                        -1.86387626e-01, 1.22130807e-01,-1.65163457e-01, 1.28655516e-01,
                        -7.36128818e-02,-9.29180756e-02, 3.05857995e-01, 3.52707658e-02,
                        -8.74292432e-02,-1.87825081e-01, 1.27504529e-01,-5.12320393e-01,
                        1.29073963e-01, 5.76239163e-02, 1.58674618e-02, 1.93959551e-01,
                        -1.83154671e-01, 9.11098787e-02, 1.52481087e-01,-1.46751133e-01,
                        9.62353494e-02,-8.62437625e-02, 2.18232930e-01,-9.12094277e-02,
                        1.05402688e-01, 9.24206014e-02, 2.30360741e-01, 1.57583516e-01,
                        3.21195832e-01,-2.09480579e-01, 5.64234845e-03, 1.19392931e-01,
                        -2.39266072e-01,-1.97726538e-01, 8.83576304e-02, 2.83417859e-01,
                        2.41804185e-02, 1.11063578e-01,-2.75570228e-01,-1.16421367e-01,
                        -1.63187326e-01,-6.05636796e-02, 4.42282048e-02, 1.98817457e-02,
                        -1.56936810e-02, 9.41469309e-02, 9.95416824e-02, 6.22844380e-02,
                        -2.29793356e-01,-1.58354737e-01,-5.78575972e-02, 6.79836607e-02,
                        1.66300593e-01, 1.54500161e-01, 1.52347852e-01,-2.02671142e-01,
                        6.87776593e-02,-3.79499881e-01, 1.90608594e-01,-1.12396590e-01,
                        8.50046662e-02, 4.82193633e-02,-1.03023851e-01,-4.87874055e-01,
                        -1.68597801e-01,-1.12515664e-01, 5.01613165e-02,-1.36720882e-01,
                        4.07941396e-01, 2.27427864e-01, 2.12518015e-01, 5.79102291e-02,
                        -2.50648362e-01, 8.24819074e-02,-9.72822919e-02, 6.97066257e-02,
                        1.24051465e-01, 1.31209344e-01,-6.12647269e-02, 2.65185099e-01,
                        -2.66095219e-02, 1.84549526e-01, 4.49298948e-02,-2.08181867e-01,
                        -2.62280430e-02, 1.70924692e-01,-9.92159620e-02, 1.15196296e-01,
                        -3.01295519e-01,-1.94648438e-01, 2.21330557e-01,-2.04794337e-01,
                        -5.90958674e-02, 1.49619520e-01,-1.65164516e-01, 2.72988156e-01,
                        -1.76498656e-01,-2.51007128e-01, 1.67306051e-01, 1.30269318e-01,
                        -2.87250661e-02,-1.38717265e-01, 1.78356808e-01, 8.67116455e-02,
                        1.51982936e-01, 3.10393129e-01, 2.45539771e-01,-2.51272202e-02,
                        1.20759546e-01, 1.49351367e-02, 5.50847287e-01,-1.35023435e-01,
                        -2.11617998e-01, 1.39030066e-02,-1.73203579e-02, 1.77624163e-01,
                        7.33985580e-02, 1.25203540e-01, 1.15327577e-01, 2.35796169e-01,
                        -2.19305985e-01, 8.82988706e-02,-1.65898527e-01, 1.10115959e-01,
                        -6.78980339e-02, 6.91733285e-03,-7.96132863e-02, 1.06421003e-01,
                        -1.50150899e-01, 1.59653520e-02, 8.30876766e-02,-3.21253549e-01,
                        1.76594240e-01, 8.46226659e-02,-2.15794159e-01,-6.61536927e-02,
                        -5.10489570e-02,-1.25946510e-01, 4.09530163e-01, 5.10010585e-02,
                        2.43565022e-01, 1.05028951e-01,-1.26621095e-01, 1.83833296e-01,
                        -2.02796264e-01,-2.56150436e-01,-1.13151083e-01, 7.18271444e-02,
                        -2.13137138e-01,-1.43324553e-02, 8.84444613e-02,-6.36744111e-02,
                        -1.08272470e-01, 2.40018954e-01,-1.87844434e-01, 5.82645036e-02,
                        1.71417820e-01, 1.79481591e-01, 3.41958439e-01, 8.84935077e-03,
                        -2.08727147e-01, 9.27633169e-02, 2.49480703e-01, 2.13445038e-01,
                        3.45138214e-02,-6.12242451e-02,-5.08856637e-02, 8.07505143e-02,
                        1.18731234e-01, 1.69238800e-01, 9.34098280e-02, 2.92380108e-01,
                        -2.77244898e-01,-1.09050642e-01,-3.63470308e-01, 1.16060319e-01,
                        -3.69747351e-01, 1.05978505e-01, 3.14981639e-02,-2.82157837e-01,
                        -7.22190696e-02,-2.99846390e-02, 1.09532798e-01,-6.10282946e-02,
                        2.55845497e-02,-4.72398452e-02,-2.02243942e-01, 1.18508807e-01,
                        -8.92730119e-02,-3.44580900e-01,-4.07409816e-02, 1.34559243e-01,
                        -1.18042759e-01,-1.03437851e-01,-5.91014253e-02,-1.17023100e-01,
                        -1.18877968e-01,-2.44069771e-01, 1.92009904e-01, 1.90353034e-01,
                        -3.18907053e-01,-9.80278800e-02,-8.71104196e-02, 1.74329497e-01,
                        1.16152857e-01,-4.21520111e-01,-9.09593402e-02, 3.76637243e-02,
                        -8.40795659e-02, 4.72546015e-02, 3.38733726e-01, 1.62233180e-01,
                        -1.21438406e-01,-1.26954477e-01,-1.06833895e-01,-3.67544144e-02,
                        -1.28346582e-01,-8.28992960e-02,-2.73574307e-01, 4.42777322e-02,
                        2.15377667e-01, 1.51822967e-01,-1.93641851e-01,-2.45248697e-01,
                        -2.00341014e-01,-1.23167223e-01,-2.66496797e-01,-2.71521589e-01,
                        -2.06892896e-02,-1.26898261e-01, 1.91972464e-01,-2.52523694e-01,
                        3.23579156e-02, 1.44969214e-01,-1.84061373e-01, 5.35421186e-02,
                        -2.15044950e-01,-1.84243140e-02,-1.28373528e-01, 4.83875350e-02,
                        -1.42072316e-01,-1.37105412e-01,-4.01617753e-01, 1.45873047e-01,
                        1.75716233e-01, 1.03573360e-02,-1.58570304e-01, 1.83100665e-01,
                        6.74818256e-02,-2.53043734e-01, 4.70072663e-02, 3.64441659e-01,
                        1.67321279e-01, 1.13261072e-02, 1.03423864e-01, 7.02637497e-02,
                        -1.61630156e-01,-1.50240514e-01,-1.80111217e-01, 1.01685675e-01,
                        -4.05816525e-01,-1.29649242e-02, 1.75328124e-01,-9.41059425e-03,
                        -9.79818226e-02, 1.74931485e-01, 2.75873354e-02,-1.90245922e-01,
                        -1.83363465e-02, 5.65643193e-02,-1.80695494e-01, 6.89705898e-02,
                        2.32372689e-02,-4.93564140e-01, 9.48097221e-02,-1.90890044e-01,
                        -1.50916867e-01, 5.89613722e-02, 2.88049802e-02,-6.04332137e-02,
                        2.83114684e-02,-3.16240905e-02,-9.51315896e-02,-1.69334915e-01,
                        -4.12002898e-01, 2.21571470e-01, 3.38429734e-02, 1.22151326e-01,
                        -1.89927126e-01,-3.78691789e-01, 4.80621608e-02,-1.17496920e-01,
                        -7.04193385e-02, 3.45105499e-02, 5.32911054e-03,-1.61420057e-01,
                        1.47498773e-01,-2.80018723e-01, 1.88603153e-01,-8.46549465e-02,
                        -1.76860820e-01, 6.40910690e-02, 1.32838188e-01, 2.04302727e-01,
                        2.42964017e-01, 3.10195835e-01,-9.20434644e-02,-1.01225444e-02,
                        2.18131385e-02,-1.28159250e-01,-9.98161488e-02,-3.04654524e-01,
                        1.96135318e-01,-1.13478552e-01,-3.59448521e-01,-9.63397239e-02,
                        -3.02412828e-02, 3.62195583e-02,-1.58986526e-01, 1.83448140e-01,
                        -2.26743165e-01,-3.79870678e-02,-3.16586001e-01,-1.64545473e-02,
                        1.89385332e-02,-8.41709055e-02, 6.54205396e-03,-1.01432052e-01,
                        2.94920267e-01,-3.04720036e-01,-1.29521285e-01, 1.96043995e-01,
                        7.25138638e-02,-6.71183913e-02, 1.85351552e-01,-6.89760780e-02,
                        -1.42468727e-01,-1.27662286e-04, 1.49424404e-03, 1.16336547e-01,
                        -5.34043578e-01,-5.66188829e-02, 3.27269790e-02,-5.52164438e-02,
                        -1.31639181e-01,-5.17254318e-02, 2.80390991e-01,-1.36527425e-01,
                        -1.83200174e-01,-2.57472296e-01, 2.72599879e-02, 2.70652167e-02,
                        -1.61534152e-01, 9.18944597e-02, 8.23051848e-02, 1.46037395e-05,
                        1.98776923e-01,-1.44903906e-01, 4.24228775e-04,-3.72606936e-01,
                        -8.84573044e-02,-1.74768783e-01, 2.77763785e-01, 3.10210367e-02,
                        -3.06804472e-01,-3.08266373e-01, 7.97796784e-03,-2.86031357e-01,
                        2.37589981e-01,-1.45360747e-01, 3.42944645e-01,-1.57822324e-02,
                        1.05422018e-01, 2.90391627e-01, 6.35112312e-02, 4.68362594e-02,
                        -2.87050937e-02,-3.36210858e-02, 1.43065185e-01, 2.08902498e-02,
                        1.70575247e-02, 6.48737578e-02, 8.19684848e-02, 2.01593209e-01,
                        -1.61651877e-01, 2.85528919e-02,-1.36296606e-01, 2.81181438e-01,
                        1.56344056e-01,-3.44079496e-01, 4.27024988e-02, 7.87161562e-02,
                        -9.84463335e-02,-6.96799369e-02, 9.56919644e-02, 1.26395942e-01,
                        1.75818821e-01, 2.12465629e-01,-2.35069323e-01,-1.28615945e-01,
                        3.96985545e-01, 1.41965896e-01,-2.70781095e-01, 4.47071226e-03,
                        3.08374477e-02,-1.04099340e-01, 2.73856915e-01,-9.99865478e-02,
                        -2.35693144e-01,-1.29546754e-02,-1.54803910e-02, 2.72799365e-01,
                        -1.82340073e-01, 1.34428716e-01,-3.16029826e-02,-8.03343725e-02,
                        -1.95705145e-01, 1.93255612e-01,-1.17373530e-01,-2.04134071e-01,
                        -1.19876004e-01, 2.23397229e-01,-4.20386655e-02, 1.51629010e-01,
                        2.64548221e-01,-5.13954572e-02,-2.78534585e-02,-1.79089722e-01,
                        1.96463614e-01,-3.35784599e-01,-1.77274262e-01,-5.80167489e-02,
                        -7.21358660e-02, 2.26447080e-01,-5.34053530e-02, 1.57735100e-01,
                        3.74796333e-01, 2.83164790e-01, 1.13199481e-01,-1.52033870e-01,
                        -1.83323770e-01,-8.29636496e-02,-8.60670672e-02,-6.88836057e-02,
                        -2.77631814e-01, 8.23169358e-03, 1.25174847e-01,-4.46699623e-02,
                        -1.82165786e-01, 2.93229017e-01,-1.45398869e-01,-6.30224851e-02,
                        -1.45419327e-01, 8.56158549e-02,-2.87169437e-02, 1.07363759e-01,
                        -6.82623221e-02, 1.67607984e-01, 4.46996345e-01, 2.69245513e-01,
                        6.64354859e-02,-2.78794530e-02, 1.79684079e-01, 6.62767511e-02,
                        2.37078311e-02, 1.62822003e-01, 8.69528300e-02,-4.37002023e-02,
                        9.71823683e-02,-3.29116466e-01,-2.42871240e-01, 7.64780457e-02,
                        2.79239109e-01,-1.45095696e-01, 2.82599778e-01, 6.37711619e-02,
                        -1.94576405e-01, 1.51207080e-01, 5.88856465e-02,-4.10068524e-02,
                        -1.79730899e-01, 2.29325137e-01, 1.39688374e-01,-1.54030606e-01,
                        -1.49481797e-01,-1.40023444e-01,-8.37201105e-02, 2.05296346e-01,
                        -2.26798317e-02,-6.43536147e-02,-2.29099289e-01, 9.59096515e-03,
                        -3.62818584e-01, 4.25022534e-01, 1.50433547e-01, 2.79637700e-01,
                        1.11687973e-01, 2.31233922e-02, 3.20285673e-01, 2.50130010e-01,
                        2.46977303e-02, 5.28524527e-02, 9.15013851e-02, 3.35230226e-02,
                        -1.74732456e-01,-9.70202388e-02,-4.08265564e-02, 7.55485676e-02,
                        -6.51517038e-02,-2.64939292e-03, 2.58969927e-01,-2.69418955e-02,
                        -1.31545260e-01, 1.72255350e-01,-1.35757880e-01, 6.71274992e-02,
                        3.28483602e-01,-2.35953086e-01,-1.69103479e-02, 5.39683305e-02,
                        -1.30895265e-01, 2.41907681e-01,-5.07857464e-02,-1.50367426e-01,
                        -9.11714418e-02, 1.47260159e-01,-2.10438834e-02,-2.64573022e-01,
                        -2.18352349e-01,-1.18556849e-02,-1.71929869e-02, 2.98041490e-01,
                        7.29995411e-02,-1.11848914e-01,-2.77239738e-01,-4.09349698e-01,
                        8.66899048e-02, 9.80290097e-02,-9.24721955e-02,-3.32253853e-01,
                        -1.55412743e-03, 1.10887904e-02, 1.05527617e-02, 1.62836433e-01,
                        -1.37132514e-01,-1.63140332e-01, 4.23002377e-01,-7.44612750e-02,
                        -1.18897749e-01, 1.17404397e-01, 1.21177508e-02,-6.51499637e-02,
                        1.31341289e-01, 1.32846158e-01,-1.95050713e-01, 9.08486266e-03,
                        2.32257385e-01, 2.94214743e-02,-6.93208448e-02,-1.61166334e-01,
                        7.64754626e-02,-7.47296286e-02, 1.80720685e-01, 3.39261070e-02,
                        -3.55939609e-02,-9.36090591e-02,-2.15877256e-01,-4.40962515e-01,
                        -5.08979820e-02, 6.98497579e-02, 3.08314300e-01, 4.12399956e-01,
                        -3.87136776e-04, 3.20061679e-02,-6.12330132e-03, 9.58645663e-02,
                        -1.48052118e-01, 8.54816928e-02,-5.78156104e-02, 1.73206579e-01,
                        1.91273519e-01, 1.62153615e-01, 4.41258165e-01,-6.91954212e-02,
                        3.18944244e-01, 4.37240060e-02,-1.34325855e-01, 1.51114385e-01,
                        -1.73549421e-01, 3.58602326e-03, 8.05376963e-02, 7.14064189e-02,
                        1.36230517e-02, 6.19383457e-02, 4.11645584e-02,-1.80165296e-01,
                        -2.12421235e-02, 9.29445946e-02,-2.76909285e-02,-1.16990557e-01,
                        1.04853611e-01, 3.15450147e-01,-6.74853416e-02,-2.49218632e-02,
                        9.72209128e-02, 3.52663763e-01, 1.86803404e-01,-3.77761023e-01,
                        -1.58535591e-01,-7.04117765e-02,-8.46884909e-02,-3.22207713e-01,
                        1.13256973e-02, 1.87717106e-01,-8.76283196e-02,-5.75031912e-02,
                        -3.87484135e-01, 1.04615087e-01,-1.46962091e-01,-1.31522744e-01,
                        -1.64913932e-01, 2.03028973e-02, 2.08441516e-01,-4.07087719e-01,
                        -6.30182468e-02, 1.98874421e-01,-2.75338326e-02,-3.66101929e-01,
                        -1.03285040e-01,-1.51651013e-01, 2.18736281e-01,-4.35161894e-02,
                        -3.07848406e-02, 9.28265798e-02,-1.17555093e-01, 1.16305842e-01,
                        -1.36748019e-01,-9.89284727e-02, 1.26228115e-01,-1.80993588e-01,
                        -1.59837840e-01,-3.26534979e-02, 1.32740717e-01, 2.71721293e-01,
                        1.39388380e-01, 1.39864586e-01,-1.05487449e-01,-2.98066594e-01,
                        -8.16403205e-02,-1.49353527e-01,-1.17348430e-01,-2.98919775e-01,
                        -1.95451123e-02,-9.30816126e-02,-1.37697653e-01, 1.23903340e-01,
                        -1.01921163e-01, 8.85585213e-02, 7.02341264e-02, 2.34903989e-01,
                        2.49810366e-02,-3.38661894e-01,-2.13679512e-01, 3.82953042e-01,
                        -7.16774029e-02, 2.03110875e-01,-4.83860800e-02, 9.43080134e-02,
                        -3.31640794e-01, 4.06915188e-02, 1.39386110e-02,-1.09920927e-01,
                        -1.46825653e-01,-8.17848594e-02,-8.35997026e-02, 2.24401873e-01,
                        -2.68717322e-01, 2.88128780e-01, 1.04492338e-01, 5.55566295e-02,
                        -3.81183625e-01,-4.40867682e-02, 9.57886760e-02, 2.06648545e-01,
                        -4.17784391e-02, 5.11334866e-02,-4.81523913e-02,-1.45802903e-02,
                        1.57209391e-01, 1.02200520e-01,-1.55961802e-01, 2.19151270e-01,
                        -3.44830816e-02, 3.42268381e-01,-2.57471588e-01,-1.90719598e-02,
                        -2.27804191e-02, 3.18357420e-01, 1.11449689e-02,-9.47202621e-03,
                        9.46689632e-02,-3.41217786e-01, 1.36100085e-01, 2.56600372e-02,
                        -1.32335572e-01,-2.46506397e-01,-2.12008887e-01,-1.47941919e-02,
                        1.16552743e-01, 2.62561294e-01, 3.71125997e-02, 1.56381951e-01,
                        2.60096931e-01,-2.18628323e-02, 1.11741162e-01, 5.26340803e-02,
                        6.67200487e-02, 3.09643303e-01,-2.50214411e-01,-3.30062083e-01,
                        1.07262678e-01,-1.44949011e-01, 3.61760203e-01, 5.45647373e-03,
                        1.75574312e-01,-1.89264447e-01,-5.63168470e-02, 2.27460711e-01,
                        -3.18610113e-02,-1.31538538e-01,-1.36168559e-01,-6.39421624e-02,
                        1.88321292e-01,-2.13757680e-01, 2.08331145e-02,-7.36458589e-02,
                        -1.69724827e-01,-2.19895587e-01,-1.29973043e-01,-2.04192563e-01,
                        -7.31680787e-02,-1.82410747e-01,-2.58508652e-01,-1.46859512e-01,
                        9.53172027e-02, 4.18525116e-01,-1.26193827e-02, 2.56161962e-02,
                        -3.18246282e-02,-3.89887386e-02,-1.84467066e-01, 2.02236095e-01,
                        1.58142816e-01, 1.66725294e-01, 1.25145390e-01, 9.30139104e-02,
                        3.95961425e-02, 1.21597976e-02, 2.39404216e-01, 7.58700287e-02,
                        6.38583090e-02, 4.02505178e-01, 2.50938533e-01,-2.06300655e-01,
                        9.85589885e-02,-3.44314709e-02,-1.95697544e-01,-1.09473567e-01,
                        -1.59548352e-01, 2.52559858e-01, 2.25007163e-01,-1.51634466e-01,
                        1.37435328e-01, 8.13116608e-02, 2.86993499e-01,-1.61883337e-01,
                        -7.72761347e-02, 8.60392988e-02,-9.97403577e-02, 1.10875393e-01,
                        2.00545715e-01,-9.73070499e-02, 1.38765927e-01, 1.50764179e-01,
                        2.90424577e-01,-3.42722163e-01,-1.08235550e-01, 9.24006971e-02,
                        1.28191160e-01,-2.09025112e-01, 1.96485898e-01,-3.36228657e-02,
                        1.07773169e-01,-2.42315848e-02,-1.39916748e-01,-1.77170096e-01,
                        -7.76332908e-02,-4.05350414e-01,-1.06911087e-01,-9.44600521e-02,
                        -1.97181876e-01, 3.84057150e-01, 4.39591665e-02,-3.13562845e-02,
                        -5.71523937e-02, 2.52027800e-01,-3.44149170e-02,-1.10364324e-03,
                        9.19345051e-02, 1.24438151e-01, 8.74391864e-02,-2.34676822e-01,
                        -9.73823005e-02, 9.23596929e-02,-8.89248400e-02,-1.49583764e-01,
                        1.03922546e-01, 2.26812959e-02,-9.16635678e-02, 1.63932125e-01,
                        -4.33301594e-01, 1.58426845e-01, 1.91575944e-02, 1.03875757e-01,
                        5.34681057e-02,-1.09215238e-01,-1.01728706e-01, 1.25119163e-01,
                        1.72486625e-01, 1.35453718e-01,-4.96327947e-01,-4.42002757e-02,
                        -2.38972964e-01, 3.22903050e-02,-1.53871983e-01, 3.01456021e-02,
                        8.73225832e-02, 8.24078328e-02,-2.70168012e-01, 2.65209683e-01,
                        -2.91101408e-02,-2.81500620e-01,-2.76133649e-01, 2.03140473e-01,
                        2.41204505e-02,-2.33520693e-02, 1.66284032e-01, 3.34534857e-03,
                        -6.63518878e-02,-2.53526215e-01,-9.15072731e-03,-8.72690099e-02,
                        2.40443293e-01, 4.56334961e-02, 6.78339409e-02, 5.94762755e-02,
                        2.46433259e-01, 3.07048706e-01,-4.76723780e-02, 1.71626493e-01,
                        -2.90981897e-02, 1.55767733e-01,-3.19088841e-01, 2.73951871e-01,
                        -1.46526044e-01,-8.72474561e-02, 4.02674050e-01,-9.50211307e-02,
                        -1.43915119e-01,-1.16429437e-01, 2.13915206e-01, 1.27790250e-01,
                        -4.83690020e-02,-2.06861192e-01,-8.67124118e-02, 6.24193288e-02,
                        7.03046488e-02, 8.95008418e-02,-2.03223922e-01,-2.93638171e-01,
                        -1.13867771e-01, 1.57729188e-01,-1.44265276e-01, 1.38757539e-01,
                        -4.76396728e-02,-6.28904675e-03, 2.09755055e-01, 2.48618320e-01,
                        4.00859820e-01,-1.06122657e-02, 1.52566996e-01,-2.83209093e-01,
                        1.75275292e-03, 1.77766501e-01, 1.37809867e-01, 7.38488837e-02,
                        -2.08344109e-01, 2.25600327e-01, 1.28708341e-01, 4.75908978e-04,
                        -3.53452953e-01,-1.65126306e-01,-9.43474429e-02,-1.95477385e-01,
                        8.91170411e-02,-1.35206246e-01,-4.10628664e-02, 5.23914389e-02,
                        3.52909404e-02, 9.97945150e-02, 3.73579590e-02,-1.24867947e-01,
                        -3.00009313e-02,-2.31325783e-02,-1.73566370e-01,-3.37297277e-01,
                        1.97180165e-01,-1.38685840e-01,-2.57884937e-01, 8.22899654e-02,
                        -4.25398513e-01, 9.46629607e-02,-2.94824139e-03,-2.94136463e-01,
                        2.51312346e-01, 5.50478811e-02,-1.06419856e-01,-1.71397243e-02,
                        -1.98918361e-01,-9.86914974e-02, 5.57366649e-02, 2.22533865e-01,
                        5.36648862e-02, 1.40793587e-01,-1.71491021e-01, 3.53009583e-01,
                        4.84946594e-02, 1.52245588e-01,-8.66227321e-02,-1.54898902e-01,
                        -1.69518087e-01,-3.90184583e-01, 8.04863502e-02, 4.28988801e-02,
                        2.75410893e-01,-9.07717770e-02,-1.97563385e-01,-4.42763864e-03,
                        -1.28243923e-01,-2.64505824e-01, 6.67570694e-02, 3.01620483e-02,
                        -1.05010166e-01,-1.19146991e-01, 9.27683469e-02,-1.21089119e-01,
                        2.89191295e-01, 8.05723004e-02, 3.06419528e-01, 1.66083537e-01,
                        -1.75053823e-01,-7.83755844e-02, 1.32209156e-01,-1.61601039e-01,
                        2.00261705e-01,-3.35263191e-01,-7.22732770e-02, 3.21958088e-01,
                        8.00067905e-02,-6.05645104e-02, 7.34463561e-02,-2.61860260e-01,
                        3.84975664e-02,-4.01550690e-02, 5.67936140e-03, 3.91726883e-02,
                        1.49966325e-01,-9.70883379e-02,-9.23743131e-02,-2.54132329e-01,
                        -8.05014922e-02, 2.70128083e-01,-4.14952015e-01, 1.29645100e-01,
                        1.59607355e-01, 3.74163575e-02, 4.71428485e-02, 4.41712506e-02,
                        -1.36072639e-01,-2.16686796e-01, 1.01482516e-02,-3.15344519e-01]).reshape(32,32)

    Vwm = np.asarray([-1.50455894e-01,-1.30413475e-01,-1.18105948e-01,-2.32135712e-01,
                        -1.74522898e-01,-1.54110827e-01,-1.76619957e-01,-1.39579845e-01,
                        -2.11670973e-01,-1.45964638e-01,-1.66435367e-01,-1.75216993e-01,
                        -2.05109898e-01,-1.91537257e-01,-1.58277472e-01,-2.20956361e-01,
                        -1.93697934e-01,-1.33508334e-01,-1.43061426e-01,-1.77862044e-01,
                        -1.30204693e-01,-1.78110468e-01,-1.73695300e-01,-1.87165164e-01,
                        -1.70581738e-01,-2.16424205e-01,-1.83004909e-01,-2.02082683e-01,
                        -2.23249581e-01,-1.77161302e-01,-1.56166591e-01,-1.82453200e-01,
                        1.87081538e-01, 1.10119774e-01,-1.88769469e-02, 4.38004883e-02,
                        1.83075704e-01,-2.68527592e-01,-2.09892455e-02, 3.98661740e-02,
                        3.24573870e-01,-5.16164365e-03,-1.31682406e-01,-3.20580421e-01,
                        -2.16069146e-01,-2.17861427e-01,-3.91015612e-02, 3.04172361e-03,
                        6.30035195e-02,-5.78287609e-02,-2.50945699e-01, 3.52982171e-02,
                        2.32706951e-01, 4.14509118e-02, 1.10450070e-01,-1.60623898e-01,
                        -3.81232380e-01, 4.74416246e-02, 5.30797361e-02, 2.56126443e-01,
                        3.25519676e-01, 9.24431317e-02,-1.00449809e-01,-1.25546118e-01,
                        -4.58823606e-02,-1.11980254e-01,-2.07671048e-01,-1.95526051e-01,
                        -5.50388899e-03,-1.34819402e-01, 8.45956101e-02, 2.75639458e-01,
                        1.37731884e-03,-1.55312870e-01, 2.14308393e-01, 1.43490739e-01,
                        -2.72531209e-01, 1.72881524e-01, 1.95998880e-01, 9.93729781e-02,
                        1.95066954e-01, 1.53439618e-01,-1.81122260e-01,-3.85649835e-02,
                        -1.28131173e-01, 2.28832256e-01, 1.38914858e-01,-5.68290827e-02,
                        -8.56517622e-02,-1.14108780e-01,-2.17410524e-01,-2.04139969e-01,
                        -5.37329883e-02, 4.01747988e-01,-2.65507488e-01, 1.68188855e-01,
                        8.95650618e-02,-1.06684068e-01,-3.26263073e-01, 1.33216333e-01,
                        2.11808155e-01,-1.16106177e-01, 1.75254387e-01, 5.58505887e-02,
                        2.87188229e-01, 6.30560197e-02,-1.73318305e-03, 4.15476540e-02,
                        2.17723797e-01, 2.17534896e-01, 7.06366143e-02,-2.41924311e-01,
                        -1.16265305e-01, 1.03711118e-01,-1.85992685e-01, 2.44239008e-01,
                        -1.58587515e-01,-5.85516098e-02,-3.34626150e-01,-1.95494201e-01,
                        -9.26565934e-02, 1.72672602e-01, 2.18999516e-01,-3.10985844e-01,
                        -1.31890895e-01,-6.02436113e-02, 5.77057674e-02,-1.14377996e-01,
                        -3.04432184e-01,-4.21295078e-02, 7.92375803e-03, 9.41210867e-03,
                        -6.61338154e-03, 2.11820994e-01,-2.15592874e-01, 2.52099091e-01,
                        9.52704820e-02,-1.74939532e-01,-5.72238896e-02,-7.54814304e-02,
                        1.40171679e-02,-1.28926232e-01, 1.72351787e-01, 1.06462427e-01,
                        -2.55490430e-01, 2.69081514e-01, 1.73027164e-01,-2.20711096e-01,
                        1.31940683e-01,-1.11611466e-01,-2.69829634e-01, 1.64546262e-01,
                        -2.36194841e-01, 3.12591448e-01, 1.59553992e-01,-8.37015497e-02,
                        1.28235280e-01, 8.70113133e-03,-2.45783721e-01, 1.86984089e-01,
                        2.10773713e-01,-3.70275201e-01, 1.38828835e-01,-1.17834615e-01,
                        -2.13996362e-02,-1.65591839e-01,-2.24229134e-02,-3.00158957e-02,
                        -5.47847733e-02,-1.64635756e-01,-2.91365521e-01, 1.19935481e-01,
                        9.81093545e-02,-3.47923632e-01,-6.64320889e-02, 9.34618491e-02,
                        -6.44262719e-02,-3.65892434e-02, 1.06339159e-01, 2.71573174e-01,
                        2.68343155e-01, 2.84833228e-01, 1.16890219e-01,-1.39415787e-01,
                        1.27164430e-01, 1.86661463e-01, 1.57278087e-01,-2.04646595e-01,
                        -2.09664181e-01, 7.13838267e-02,-6.95348471e-02, 1.85777413e-01,
                        -1.33837470e-01, 9.03554903e-02,-1.02976962e-01,-2.22842466e-01,
                        -3.75593890e-01, 5.39209722e-02, 2.36820870e-01, 2.40746359e-01,
                        -3.24476941e-02, 4.37383036e-01,-2.62408100e-01, 8.96678426e-02,
                        7.70283044e-02,-2.86656506e-02, 3.54398225e-02,-2.94637538e-01,
                        2.35776335e-01, 9.52437033e-02, 4.13583624e-02,-5.68323294e-02,
                        1.48865178e-01, 5.15354636e-02, 1.19321649e-01,-1.80191851e-01,
                        2.84737874e-03,-3.08440623e-02, 1.41133842e-01,-6.48067867e-02,
                        2.15416632e-01,-2.17073224e-01,-1.62084479e-01, 7.45745919e-02,
                        2.19751936e-01, 2.21408157e-01,-1.87086649e-01, 5.87795083e-02,
                        -6.48228847e-02,-9.85377739e-02,-2.47934913e-01, 3.07985184e-01,
                        -4.22218284e-02,-1.93559631e-01, 1.10160667e-02, 2.88456636e-01,
                        -5.99880665e-05,-1.16134478e-01, 2.53460987e-01,-2.29082103e-01,
                        1.02251834e-01,-3.70303724e-01, 1.51804525e-01, 1.07774502e-01,
                        1.45624848e-01,-1.93727141e-01, 5.17466851e-03, 2.06189178e-01,
                        1.19638773e-01, 1.33566319e-01,-1.10004264e-01,-7.63205106e-02,
                        4.89678983e-02, 1.69333174e-02,-9.67115117e-02,-3.09149174e-01,
                        -1.71368536e-01, 6.89141785e-03, 1.62293256e-01, 1.94992007e-01,
                        -2.78988910e-01,-1.61441783e-01, 7.53422283e-02, 1.57298008e-01,
                        1.43342913e-01,-5.02511209e-02, 1.88561969e-01,-2.87913301e-01,
                        1.74113336e-02, 4.50217628e-02,-3.22621376e-01, 3.15789505e-02,
                        3.20589494e-01, 1.30742157e-02, 2.81800991e-01, 2.80301353e-01,
                        1.76718587e-01,-2.00055486e-01,-2.41618387e-01,-1.24285092e-01,
                        9.19528785e-05, 5.34737546e-02,-2.76486038e-01,-1.15323428e-01,
                        -8.95491497e-02, 1.12482584e-01, 1.35919275e-02, 5.92143480e-02,
                        2.01836137e-02,-3.17881265e-01, 4.27455233e-04, 1.87663423e-01,
                        1.70907289e-01, 1.47082842e-01,-1.89576089e-01, 2.72486680e-01,
                        -1.71961054e-03,-1.08601128e-01,-1.12681673e-01,-1.47352817e-01,
                        -5.47797325e-02,-5.67022281e-02,-4.56102441e-02,-7.82708672e-02,
                        2.78037596e-01, 4.21589368e-01, 7.60871444e-02, 1.64102303e-01,
                        -1.57958478e-01,-1.62513011e-02, 2.60586884e-01, 1.52916287e-01,
                        2.65050473e-02,-2.46022596e-01, 6.97776499e-02, 4.64095114e-02,
                        -8.64603541e-02,-2.74184474e-01,-5.27183639e-02,-2.89338056e-01,
                        3.50698078e-02,-2.48275951e-01, 3.10781452e-01, 1.74356649e-01,
                        -2.54402066e-02, 3.37830835e-01, 8.08818105e-02,-8.28962002e-02,
                        -1.16228689e-02, 2.52523698e-01,-2.55722924e-02,-1.24148329e-01,
                        -1.92543104e-01, 4.67091328e-02, 3.19223841e-01,-2.51598388e-01,
                        5.88589691e-02,-1.50524032e-01,-1.44897049e-01,-6.41106844e-04,
                        5.76040822e-02, 1.73294841e-01,-1.42455838e-02, 6.13479745e-02,
                        -1.58017799e-01, 3.44631846e-01,-3.37491353e-01,-3.01172014e-02,
                        -1.98653405e-01, 4.50372988e-03,-3.83896771e-02,-1.16551857e-01,
                        -1.12783906e-01,-7.28657383e-02, 1.58649943e-02,-2.05791465e-01,
                        9.47154495e-02,-2.98938493e-01,-8.74293855e-02, 1.84826973e-02,
                        -2.12214103e-02, 1.80485953e-01, 2.27153737e-01,-2.74996931e-01,
                        5.77241977e-02,-1.64879688e-01, 3.79250983e-01,-1.56896806e-01,
                        -1.95768344e-01, 1.02099922e-01,-2.75463323e-02, 2.24643877e-01,
                        6.04349301e-02,-1.89598295e-01, 2.10188442e-01, 1.79449177e-01,
                        7.67440134e-02,-6.69891745e-02,-1.63956536e-01,-1.47072578e-01,
                        1.16154968e-01,-1.20154354e-01, 3.12328916e-01, 2.71132368e-01,
                        -2.51385794e-01, 6.83074937e-02,-1.25325427e-01, 2.48470795e-01,
                        -2.96874931e-01,-4.41048023e-02,-4.61077121e-01,-5.15296347e-02,
                        -1.37103930e-02,-5.69822798e-03, 2.17851037e-01,-1.71586954e-02,
                        7.95163070e-02, 1.55088119e-01, 1.33296582e-01, 2.22500120e-02,
                        -1.56308331e-01, 5.29026315e-04,-1.04187925e-01, 1.71773700e-01,
                        1.76810552e-01, 4.90027120e-01, 2.73382886e-02,-2.52358030e-01,
                        2.35830270e-02,-8.38630546e-02, 6.27904645e-02, 1.04371096e-01,
                        5.44043576e-03,-1.38932481e-01, 1.20121807e-02,-1.01192266e-01,
                        4.06590373e-03, 4.76314238e-02,-7.79340637e-02, 3.08820168e-02,
                        7.11266825e-02, 3.06906458e-01, 1.72115564e-01, 3.11190040e-01,
                        -1.02393530e-01,-1.44560048e-01, 3.38739457e-01, 1.42652028e-01,
                        -1.83054750e-01,-2.71534557e-01,-2.73403678e-01,-1.20051111e-01,
                        -4.74648965e-02,-7.94847152e-02,-1.40728034e-01,-6.32260334e-02,
                        2.17809251e-01, 1.25789995e-01, 1.95307089e-02,-5.11904122e-02,
                        -2.14996951e-01,-4.80157980e-02, 8.08199819e-02,-1.29003896e-01,
                        -5.10429562e-02,-1.51209657e-01, 4.45682977e-01, 8.74703575e-02,
                        3.27670236e-02,-1.21454903e-01,-9.94720545e-02,-2.03089193e-01,
                        -2.84508712e-02,-6.85799469e-02, 4.53814338e-02,-1.17671612e-01,
                        3.08475682e-01, 2.65983351e-01, 9.29254026e-02, 1.51891803e-01,
                        -4.18839263e-01,-1.10940552e-01, 4.13834677e-02, 1.31240255e-01,
                        -9.57424674e-03,-3.47769332e-03, 2.50704825e-01, 1.15932936e-01,
                        8.75489508e-02, 2.18387885e-01,-4.15073630e-01, 3.22562159e-01,
                        3.75145413e-02,-2.28722379e-01, 6.32352689e-02, 7.28824411e-02,
                        -4.68169878e-02,-1.42947404e-01, 1.66356740e-03,-1.16563123e-01,
                        3.63272874e-02,-1.54165880e-01,-2.72451466e-01,-3.62917500e-02,
                        -2.05935366e-01,-1.29675070e-01, 4.40760787e-02,-2.27929961e-01,
                        -3.48079941e-02, 3.83151984e-02, 9.51760898e-02,-9.26949768e-03,
                        3.98342813e-01,-3.55939119e-02, 5.02074826e-02, 1.73805627e-01,
                        2.57359144e-01, 1.01978462e-01,-5.59961220e-02,-2.66560978e-01,
                        2.78429114e-01,-2.94497095e-02, 9.62384407e-02, 3.09514440e-01,
                        -3.65788135e-01, 3.30712085e-02, 1.23046427e-02,-2.55255555e-02,
                        -2.20061042e-01, 6.08829950e-02, 1.36293912e-01,-2.02650890e-01,
                        -1.47652562e-01,-1.82279930e-01, 1.16213983e-01,-2.92738623e-01,
                        2.24349066e-01, 1.79269199e-02,-2.93619174e-01, 2.71012152e-01,
                        -3.37501263e-02, 2.74151659e-01,-6.07003866e-02, 2.95279874e-02,
                        2.58119383e-02, 8.95053414e-02, 1.04797254e-01, 3.09482753e-01,
                        1.60583563e-01,-1.96509144e-01, 1.03253460e-01,-1.12001863e-01,
                        -1.98496565e-02,-1.11513572e-01,-7.38294124e-02,-3.67956627e-01,
                        -3.92025406e-02, 4.41121109e-02, 8.62425631e-02,-3.00002380e-03,
                        -3.91926732e-02, 1.39692376e-01, 3.28501973e-01,-2.40810081e-01,
                        -4.25089707e-02, 8.13498811e-02, 1.99458760e-01,-2.28723540e-01,
                        2.53253429e-01,-1.66410177e-01, 9.76095636e-03,-2.48044231e-02,
                        4.72789996e-02,-1.03972897e-01, 1.18282573e-01,-4.71357142e-02,
                        2.13069179e-01, 1.10275445e-01,-2.11068562e-01,-8.62968638e-02,
                        4.12390366e-02,-3.22727221e-02, 2.16742488e-01,-1.77754885e-01,
                        -1.10973455e-01, 4.37903300e-01, 3.50396802e-02, 1.02898580e-01,
                        -6.40745066e-02, 1.67969184e-01,-2.03900517e-01,-3.15190922e-01,
                        2.94535628e-01,-2.50338866e-01,-5.95474443e-02,-2.11445254e-01,
                        -4.44666485e-02,-1.92560269e-01, 7.65493205e-02,-2.19471526e-01,
                        8.20568384e-02, 1.77471924e-02,-4.37549677e-02, 2.25778494e-02,
                        1.23135769e-01,-8.87102128e-02,-7.62179889e-02, 4.24345957e-01,
                        1.08557903e-01, 2.56506016e-01,-1.77261007e-01,-8.78160643e-02,
                        -1.86849003e-01, 2.24605447e-01,-1.74457130e-01, 1.18501936e-01,
                        3.49152601e-01,-1.80016200e-01,-2.55332045e-02,-4.23117605e-02,
                        -2.97944301e-02,-9.74798633e-03,-4.18544939e-01, 3.02069896e-01,
                        7.92505169e-02,-1.03397993e-01, 1.40785644e-03,-2.90335542e-02,
                        -3.57040395e-01, 2.66816159e-01, 1.89616097e-01, 3.38751569e-02,
                        3.64461913e-02,-1.95096199e-01, 2.09299217e-01, 1.40320940e-01,
                        1.97869647e-01,-3.94103218e-03,-8.96600635e-02, 1.32714461e-02,
                        -2.17236870e-02,-2.06002787e-01, 2.30999547e-02, 6.59064051e-03,
                        -1.16848565e-01, 1.92792040e-01,-2.46711522e-01,-1.89004440e-01,
                        1.14168652e-01, 6.69282648e-02, 5.99277740e-02, 7.55980495e-02,
                        3.92536422e-01, 6.37963677e-02, 1.52591619e-02,-1.43367912e-02,
                        -3.12768719e-01, 1.31231032e-01, 5.92176392e-02,-3.45102518e-01,
                        1.69006058e-01, 2.64413455e-01,-1.80881760e-01, 2.75383115e-02,
                        7.38755866e-02, 2.36413840e-01,-2.51366704e-01,-2.08971385e-01,
                        2.06615847e-01, 3.93293726e-02,-1.82957177e-01, 5.85844280e-02,
                        9.19665219e-02,-3.22138344e-01, 7.26101000e-02,-1.00623626e-01,
                        1.59620467e-01, 3.22232362e-01, 1.27988965e-01,-1.19084427e-01,
                        -5.59472135e-02, 1.09786580e-01,-1.23732145e-01,-2.26019409e-01,
                        6.89818699e-02,-8.42698845e-02,-3.72157204e-01,-1.18465533e-01,
                        -2.68910583e-03, 1.68268382e-01, 2.10485560e-01, 1.12245184e-01,
                        6.84320111e-02, 2.24689938e-02,-8.20455398e-02,-2.41320516e-01,
                        -1.46490482e-01, 2.19729288e-01, 3.58737204e-01,-9.88666091e-02,
                        -1.84672728e-01,-1.85197551e-01, 2.12072953e-01,-1.17989523e-01,
                        3.86834485e-02,-1.82378491e-01, 2.25250794e-01, 1.86731865e-01,
                        -1.58463043e-01, 2.01089697e-01, 1.57673465e-01, 2.62612619e-01,
                        -5.77215601e-02,-3.83992844e-02,-7.53771776e-03,-2.65807439e-01,
                        1.08758960e-02, 1.11319652e-01,-5.79744660e-02, 1.18248955e-01,
                        1.65989321e-01, 2.27899276e-02,-4.40714704e-02,-4.23338097e-01,
                        2.44921845e-01,-1.55654300e-01, 1.62550175e-01,-1.14808713e-01,
                        -3.22268578e-03, 2.18537178e-01, 1.92612157e-02,-6.66203266e-03,
                        3.31141604e-01,-1.65976510e-01, 2.49790607e-01,-2.20263276e-01,
                        1.68294412e-01, 1.07124458e-01, 1.66212236e-01,-1.25268085e-01,
                        -7.09931621e-03,-1.29581515e-01,-1.92475154e-03,-3.06440134e-01,
                        2.99908936e-01,-8.43625156e-02,-1.77060258e-02,-1.62013118e-01,
                        2.61453456e-01,-3.61285733e-01, 1.36898571e-01,-1.03174245e-01,
                        -2.13154789e-02,-1.76911369e-02,-1.82461727e-01, 7.71092235e-03,
                        -1.98622073e-01,-8.77736967e-02, 7.68964365e-02, 4.12729316e-01,
                        1.39668265e-01,-2.12802054e-01, 3.30049205e-01,-3.06387003e-02,
                        -4.46362104e-02,-1.57361506e-01,-2.01036073e-01, 2.14402746e-01,
                        -8.12092216e-03,-3.98370012e-03, 3.46059792e-01, 5.07824718e-02,
                        -5.00918774e-02,-8.86904953e-02, 3.12622576e-01,-1.44005225e-01,
                        8.40035372e-02, 7.84148896e-03, 6.38948612e-03,-1.93300583e-01,
                        -2.07302935e-01,-3.28491935e-01,-1.15073230e-01,-3.16179768e-02,
                        7.74284132e-02,-1.14920653e-01, 9.11223668e-02, 1.91940782e-02,
                        -1.24774778e-01,-1.96823673e-01, 1.34754825e-01,-5.69649381e-02,
                        -4.58297071e-03,-1.66276071e-01,-2.16242600e-02,-1.66559481e-01,
                        -2.14247294e-01,-2.80134013e-01, 7.50573754e-02, 6.37095574e-02,
                        -3.61043417e-02,-7.62248838e-02, 1.28525257e-01,-3.53946747e-01,
                        4.01596668e-01, 1.10061670e-01,-1.52575582e-01,-9.04896215e-02,
                        -3.14261285e-02, 5.89552710e-02,-3.69526553e-01,-5.16441629e-03,
                        1.55404881e-01, 9.80453107e-02, 2.18510568e-01, 2.34014494e-01,
                        2.43651199e-01, 1.02384230e-01, 1.79472514e-01, 3.45847404e-02,
                        -1.11796471e-01, 4.02700084e-02,-1.94567563e-01,-7.25163769e-05,
                        3.91814138e-01,-1.03821996e-01,-1.55160516e-02,-1.44419432e-01,
                        -1.08370434e-01, 1.68515481e-01, 3.44070508e-01, 5.12959573e-02,
                        -6.44631525e-02,-9.87585119e-02,-6.17403373e-02,-2.21188342e-01,
                        7.02676762e-02, 4.76903704e-02, 3.11802116e-01,-1.09093091e-01,
                        1.24405257e-01,-6.27089702e-02, 1.46585352e-01,-2.28501692e-01,
                        2.34681437e-02, 2.00229162e-01, 5.41930665e-02, 2.66611862e-01,
                        -3.22247080e-01,-6.81572235e-02,-3.07538606e-01, 8.74814724e-02,
                        1.51590871e-01, 2.65467589e-01, 2.03211864e-02,-6.24681876e-02,
                        2.05281304e-02,-5.29062773e-02,-3.87346121e-02,-1.87430764e-01,
                        -1.04085562e-01,-1.67653005e-01,-1.05514646e-01,-4.07032619e-02,
                        -3.92762181e-01, 3.29884612e-01, 1.45286485e-01, 2.17675813e-01,
                        2.00683095e-01, 2.11908058e-01,-5.44733867e-02,-3.47643599e-02,
                        2.76898991e-01,-1.32896205e-01, 3.48721598e-02,-1.00003410e-01,
                        6.98681016e-02, 2.06584142e-01, 8.20308424e-02,-2.55128688e-01,
                        -9.36155941e-02,-3.78099897e-01, 1.05083366e-01, 4.49714122e-02,
                        1.13673119e-01, 3.30173924e-02, 3.78118158e-01, 1.92187340e-01,
                        -5.88982833e-03,-8.72369055e-02,-1.27941026e-01,-1.04191505e-01,
                        -9.21574493e-02, 2.69425949e-01, 3.17685308e-01, 3.54507788e-01,
                        5.03880864e-02,-2.78590030e-01,-7.92542463e-03, 1.69929101e-01,
                        6.47477634e-02, 1.64346197e-01,-2.48382438e-01, 3.17690991e-02,
                        -5.20259382e-02,-2.02141902e-01,-7.41350970e-02,-9.12572910e-02,
                        -1.03357883e-01,-9.32001950e-02, 6.03985719e-02,-2.75013582e-01,
                        1.43643300e-01,-6.92672017e-02,-2.70000151e-01,-7.84732813e-02,
                        2.60359848e-02, 2.27416197e-01,-2.00847626e-02,-6.68355109e-02,
                        3.17348621e-01, 6.36469325e-02, 7.94404661e-02, 1.93144155e-01,
                        -3.61271333e-01, 4.51504528e-02,-1.08863342e-01,-2.02187100e-01,
                        2.74144615e-01,-4.77533549e-02, 1.06843787e-01, 1.71731981e-01,
                        1.33743089e-01,-7.19464720e-02,-2.20367245e-01, 1.68091608e-01,
                        1.78396169e-01, 1.62116638e-01,-3.87592423e-01, 9.42920215e-02,
                        8.29957695e-03,-2.17000039e-01,-1.38315666e-01, 1.04013909e-01,
                        -1.45052584e-01,-1.35783774e-01,-2.08278491e-01, 1.16859978e-01,
                        -4.94325610e-01, 6.73843348e-02,-6.24865392e-02,-1.03168707e-01,
                        2.19675337e-01, 3.17626230e-01,-1.63269595e-02,-3.59926078e-01,
                        1.14646009e-01,-9.63555428e-02,-8.05622304e-02, 6.47944847e-02,
                        -9.77665693e-03,-1.92867296e-02,-2.51367070e-02,-3.85751719e-02,
                        1.95938361e-01,-2.10442623e-01,-7.00787549e-02, 3.42872377e-01,
                        1.53490624e-01,-9.51312450e-02, 1.62835729e-01, 9.65331202e-02,
                        -5.40249213e-02,-1.21757202e-01, 1.26315039e-01,-2.53174363e-01,
                        1.09447034e-01, 1.58229121e-01,-1.00838299e-01,-5.76055904e-02,
                        -8.07618133e-02, 1.59001954e-01, 1.95570386e-01,-2.23053251e-01,
                        -1.40837811e-01, 2.87069165e-03, 3.64496275e-03, 2.84606954e-02,
                        3.75825619e-01,-2.43607891e-01, 5.45504411e-02, 1.36822177e-01,
                        1.48292064e-01,-1.35099681e-01, 1.88712151e-01, 7.08699980e-02,
                        2.04468084e-01,-1.45054450e-01,-6.90547714e-02, 1.05989587e-01,
                        -3.49029016e-01,-1.12492610e-02, 6.40252145e-02,-6.82170417e-02,
                        -2.20142162e-01, 6.05508777e-02, 1.64910785e-02, 2.29835953e-01,
                        -2.94000836e-01,-3.44915777e-01,-3.76671957e-03, 1.90188037e-01,
                        -1.35372160e-01,-3.05696627e-01,-3.65035394e-01, 1.76333974e-01,
                        2.27700696e-02, 3.66741690e-02, 7.45556008e-02,-1.13543439e-02,
                        1.27550442e-01, 5.91501645e-03, 3.60869372e-02,-2.09617520e-02,
                        1.24975898e-03,-2.02129907e-01,-4.12751250e-02, 3.24523310e-01,
                        1.36439687e-01,-2.09437062e-01,-2.19624927e-01,-1.53792719e-01,
                        -5.77632780e-02,-5.51589219e-02, 6.68011450e-03,-5.48749039e-02,
                        3.75861518e-01, 2.20077579e-01,-2.34178039e-01,-1.72000933e-04,
                        2.33542593e-01,-3.09981970e-01,-6.61761933e-02, 8.39526735e-02]).reshape(32,32)

    # reconstruct watermark from singular values
    watermark_extracted = np.dot(Uwm, np.dot(np.diag(S_wm_reconstructed), Vwm))
    # round values and cast to int
    watermark_extracted = np.round(watermark_extracted, decimals=0).astype(int)

    # watermark_extracted = np.zeros(1024).reshape(32, 32)
    # Swm = np.zeros(32)
    # # Loop through the coordinates in the spiral
    # for i, (x, y) in enumerate(coordinates):

    #     # Extract blocks from the original and watermarked images
    #     original_block = original_image[x:x + block_size, y:y + block_size]
    #     watermarked_block = watermarked_image[x:x + block_size, y:y + block_size]

    #     # Apply Wavelet Transform (DWT) to both blocks
    #     Coeff_orig = pywt.wavedec2(original_block, wavelet='haar', level=1)
    #     Coeff_wm = pywt.wavedec2(watermarked_block, wavelet='haar', level=1)

    #     # Extract the LL sub-band (low-low) from the DWT coefficients
    #     LL_orig = Coeff_orig[0]
    #     LL_wm = Coeff_wm[0]

    #     # Perform SVD (Singular Value Decomposition) on both LL sub-bands
    #     U_orig, S_orig, V_orig = np.linalg.svd(LL_orig)
    #     U_wm, S_wm, V_wm = np.linalg.svd(LL_wm)

    #     Sdiff = S_wm - S_orig

    #     # Extract the singular values (watermark) from the watermarked block
    #     Sw_extracted = (S_wm - S_orig) / ALPHA

    #     Swm[(i*shape_LL_tmp)%watermark_extracted.shape[0]: (shape_LL_tmp+(i*shape_LL_tmp)%watermark_extracted.shape[0])] += abs(Sdiff/alpha)

    # Swm /= watermark_extracted.shape[0]
    # watermark_extracted = (Uwm).dot(np.diag(Swm)).dot(Vwm)
    # watermark_extracted = watermark_extracted.reshape(1024)
    # watermark_extracted /= np.max(watermark_extracted)

    return watermark_extracted

def find_differences(image1, image2):
    """
    Finds the coordinates where two images differ.

    Args:
    image1: The first image.
    image2: The second image.

    Returns:
    differences: An array of coordinates where the two images differ.
    """
    differences = np.argwhere(image1 != image2)
    return differences

def check_spiral_for_differences(differences, spiral):
    """
    Return number of spiral point equal to the predefinited spiral
    
    Args:
    differences: Coordinates where the images differ.
    spiral: The predefined spiral coordinates.

    Returns:
    Number of matching coordinates
    """
    matching_coords = 0
    # Count how many of the difference points match spiral points
    for diff in differences:
        if tuple(diff) in spiral:
            matching_coords += 1
    
    return matching_coords

def wpsnr(img1, img2):
    """
    Calculates the Weighted Peak Signal-to-Noise Ratio (wPSNR) between two images.
    
    Args:
    img1: The first image.
    img2: The second image.

    Returns:
    The wPSNR value between the two images.
    """
    img1 = np.float32(img1) / 255.0  
    img2 = np.float32(img2) / 255.0  

    difference = img1 - img2
    
    # If there is no difference, return an arbitrarily high wPSNR value
    same = not np.any(difference)
    if same:
        return 9999999

    # Assuming a CSF (Contrast Sensitivity Function) is saved as a CSV file
    csf = np.genfromtxt('csf.csv', delimiter=',')
    ew = convolve2d(difference, np.rot90(csf, 2), mode='valid')

    decibels = 20.0 * np.log10(1.0 / np.sqrt(np.mean(np.mean(ew ** 2))))
    return decibels

def similarity(X, X_star):
    """
    Computes the similarity measure between the original and the new watermarks.
    Returns 0 if the denominator is zero to avoid NaN values.
    
    Args:
    X: The original watermark.
    X_star: The extracted watermark from the attacked image.

    Returns:
    The similarity score.
    """
    
    # Computes the similarity measure between the original and the new watermarks.
    norm_X = np.sqrt(np.sum(np.multiply(X, X)))
    norm_X_star = np.sqrt(np.sum(np.multiply(X_star, X_star)))

    if norm_X == 0 or norm_X_star == 0:
        return 0.0

    s = np.sum(np.multiply(X, X_star)) / (norm_X * norm_X_star)
    return s

def detection(original_image_path, watermarked_image_path, attacked_image_path):
    """
    Compares the extracted watermarks from the watermarked and attacked images.
    
    Args:
    original_image_path: Path to the original image.
    watermarked_image_path: Path to the watermarked image.
    attacked_image_path: Path to the attacked image.

    Returns:
    A tuple (output1, output2) indicating whether the attack was successful and the wPSNR value.
    """
    original_image = cv2.imread(original_image_path, 0)  # Load original image
    watermarked_image = cv2.imread(watermarked_image_path, 0)  # Load watermarked image
    attacked_image = cv2.imread(attacked_image_path, 0)  # Load attacked image

    # Check if the attacked image is equal to the original one
    if len(find_differences(original_image, attacked_image)) == 0:
        return 0, wpsnr(original_image, attacked_image)

    # Find the coordinates where the original and watermarked images differ
    differences = find_differences(original_image, watermarked_image)

    # Identify which spiral has the maximum matching points based on the differences
    max_matching_points = 0
    spiral_index = None

    for idx, spiral in enumerate(spirals):
        matching_points = check_spiral_for_differences(differences, spiral)
        
        if matching_points > max_matching_points:
            max_matching_points = matching_points
            spiral_index = idx

    # Raise an error if no matching spiral is found
    if spiral_index is None:
        raise ValueError("No matching spiral found.")

    #print(f"[SPIRAL CENTER DETECTED]: {spirals[spiral_index][0]}")
    
    used_spiral = spirals[spiral_index]

    # Extract watermark from the watermarked image using the detected spiral
    watermark_extracted_from_watermarked = extract_watermark(original_image, watermarked_image, used_spiral)
    
    # Extract watermark from the attacked image using the same spiral
    watermark_extracted_from_attacked = extract_watermark(original_image, attacked_image, used_spiral)

    # Calculate the similarity between the two extracted watermarks
    similarity_w = similarity(watermark_extracted_from_watermarked.flatten(), watermark_extracted_from_attacked.flatten())

    # Calculate the wPSNR between the watermarked and attacked images
    wpsnr_value = wpsnr(watermarked_image, attacked_image)

    # Determine if the attack was successful based on similarity and wPSNR

    if(similarity_w >= THRESHOLD_TAU):
        output1 = 0 # Attack failed
    else:
        if(wpsnr_value >= WPSNR_THRESHOLD):
            output1 = 1 # Attack successful
        else:
            output1 = 0 # Attack failed

    return output1, wpsnr_value # Return result of detection and wPSNR